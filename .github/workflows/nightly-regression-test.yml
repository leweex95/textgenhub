name: Nightly regression tests

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      headless:
        description: 'Run tests in headless mode (true/false)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  chatgpt-test:
    name: ChatGPT Regression Test
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      - name: Verify Node
        run: |
          node -v
          npm -v
        shell: pwsh

      - name: Install Poetry
        run: python -m pip install --upgrade poetry==2.2.0

      - name: Install dependencies
        run: |
          poetry install
        shell: pwsh

      - name: Install Node.js dependencies
        run: |
          npm install
        shell: pwsh

      - name: Validate textgenhub installation
        run: |
          poetry run pip show textgenhub
        shell: pwsh

      - name: Create artifacts directory
        run: mkdir -p artifacts
        shell: pwsh

      - name: Run ChatGPT regression test
        env:
          CHATGPT_HEADLESS: 'false'
        run: |
          $headless = $false
          $output = node ./src/textgenhub/chatgpt/chatgpt_cli.js --prompt "What is 2 + 2? Respond with only the number, no other text." --expected "4" --headless $headless --debug 2>&1
          $output | Out-File -FilePath artifacts/chatgpt_cli_raw_output.txt
          $jsonLine = $output | Select-String '{' | Select-Object -Last 1
          $exitCode = 0
          if (-not $jsonLine) {
            Write-Error "ChatGPT regression test failed: No JSON output from CLI script. Raw output: $output"
            $exitCode = 1
          } else {
            $result = $jsonLine.Line | ConvertFrom-Json
            if ($result.error) {
              Write-Error "ChatGPT error occurred: $($result.error)"
              if ($result.artifactPath) {
                Write-Output "HTML artifact saved at: $($result.artifactPath)"
              }
              $exitCode = 1
            } elseif (-not $result -or -not $result.response) {
              Write-Error "ChatGPT regression test failed: Output JSON missing or null 'response' field. Raw output: $output"
              $exitCode = 1
            } else {
              Write-Output "ChatGPT regression test passed: ChatGPT output: $($result.response)"
            }
          }
          exit $exitCode
        shell: pwsh

      - name: Upload ChatGPT artifacts
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: chatgpt-artifacts
          path: |
            artifacts/chatgpt_*.html
            artifacts/chatgpt_cli_raw_output.txt
          if-no-files-found: ignore
  
      - name: Run ChatGPT regression test retry
        env:
          CHATGPT_HEADLESS: 'false'
        run: |
          $headless = $false
          $jsonOutput = node ./src/textgenhub/chatgpt/chatgpt_cli.js --prompt "What is 2 + 2? Respond with only the number, no other text." --expected "4" --headless $headless --debug 2>$null | Select-String '^\{.*\}$' | ForEach-Object { $_.Line }
          if (-not $jsonOutput) {
            Write-Error "ChatGPT regression test failed: No output from CLI script."
            throw "ChatGPT regression test failed: No output from CLI script."
          }
          $result = $jsonOutput | ConvertFrom-Json
          
          # Check if error occurred and HTML artifact was saved
          if ($result.error) {
            Write-Error "ChatGPT error occurred: $($result.error)"
            if ($result.artifactPath) {
              Write-Output "HTML artifact saved at: $($result.artifactPath)"
            }
            throw "ChatGPT regression test failed: $($result.error)"
          }
          
          if (-not $result -or -not $result.response) {
            Write-Error "ChatGPT regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
            throw "ChatGPT regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
          }
          
          Write-Output "ChatGPT regression test passed: ChatGPT output: $($result.response)"
        shell: pwsh

  deepseek-test:
    name: DeepSeek Regression Test
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      - name: Verify Node
        run: |
          node -v
          npm -v
        shell: pwsh
  
      - name: Install Poetry
        run: python -m pip install --upgrade poetry==2.2.0

      - name: Install dependencies
        run: |
          poetry install
        shell: pwsh

      - name: Install Node.js dependencies
        run: |
          npm install
        shell: pwsh

      - name: Validate textgenhub installation
        run: |
          poetry run pip show textgenhub
        shell: pwsh
      
      - name: Create artifacts directory
        run: mkdir -p artifacts
        shell: pwsh
  
      - name: Run DeepSeek regression test
        env:
          DEEPSEEK_HEADLESS: ${{ inputs.headless || 'true' }}
        run: |
          $headless = if ([System.Environment]::GetEnvironmentVariable('DEEPSEEK_HEADLESS') -eq 'false') { $false } else { $true }
          $jsonOutput = node ./src/textgenhub/deepseek/deepseek_cli.js --prompt "What is 7 + 13? Answer with only the number, no text, no explanation, just the single number." --headless $headless --debug 2>$null | Select-String '^\{.*\}$' | ForEach-Object { $_.Line }
          if (-not $jsonOutput) {
            Write-Error "DeepSeek regression test failed: No output from CLI script."
            throw "DeepSeek regression test failed: No output from CLI script."
          }
          $result = $jsonOutput | ConvertFrom-Json
          $expected_answer = "20"
          
          # Check if error occurred and HTML artifact was saved
          if ($result.error) {
            Write-Error "DeepSeek error occurred: $($result.error)"
            if ($result.artifactPath) {
              Write-Output "HTML artifact saved at: $($result.artifactPath)"
            }
            throw "DeepSeek regression test failed: $($result.error)"
          }
          
          if (-not $result -or -not $result.response) {
            Write-Error "DeepSeek regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
            throw "DeepSeek regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
          }
          if ([string]::IsNullOrWhiteSpace($result.response)) {
            Write-Error "DeepSeek regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
            throw "DeepSeek regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
          }
          if ($result.response.Trim() -ne $expected_answer) {
            Write-Error "DeepSeek regression test failed: expected $expected_answer, got DeepSeek output: '$($result.response)'"
            throw "DeepSeek regression test failed: expected $expected_answer, got DeepSeek output: '$($result.response)'"
          } else {
            Write-Output "DeepSeek regression test passed: expected $expected_answer, DeepSeek output: $($result.response)"
          }
        shell: pwsh

      - name: Upload DeepSeek HTML artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: deepseek-artifacts
          path: artifacts/deepseek_*.html
          if-no-files-found: ignore

  perplexity-test:
    name: Perplexity Regression Test
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      - name: Verify Node
        run: |
          node -v
          npm -v
        shell: pwsh
  
      - name: Install Poetry
        run: python -m pip install --upgrade poetry==2.2.0

      - name: Install dependencies
        run: |
          poetry install
        shell: pwsh

      - name: Install Node.js dependencies
        run: |
          npm install
        shell: pwsh

      - name: Validate textgenhub installation
        run: |
          poetry run pip show textgenhub
        shell: pwsh
      
      - name: Create artifacts directory
        run: mkdir -p artifacts
        shell: pwsh
  
      - name: Run Perplexity regression test
        env:
          PERPLEXITY_HEADLESS: ${{ inputs.headless || 'true' }}
        run: |
          $headless = if ([System.Environment]::GetEnvironmentVariable('PERPLEXITY_HEADLESS') -eq 'false') { $false } else { $true }
          $jsonOutput = node ./src/textgenhub/perplexity/perplexity_cli.js --prompt "What is 2 + 2? Answer with only the number, no text, no explanation, just the single number." --headless $headless --debug 2>$null | Select-String '^\{.*\}$' | ForEach-Object { $_.Line }
          if (-not $jsonOutput) {
            Write-Error "Perplexity regression test failed: No output from CLI script."
            throw "Perplexity regression test failed: No output from CLI script."
          }
          $result = $jsonOutput | ConvertFrom-Json
          $expected_answer = "4"
          
          # Check if error occurred and HTML artifact was saved
          if ($result.error) {
            Write-Error "Perplexity error occurred: $($result.error)"
            if ($result.artifactPath) {
              Write-Output "HTML artifact saved at: $($result.artifactPath)"
            }
            throw "Perplexity regression test failed: $($result.error)"
          }
          
          if (-not $result -or -not $result.response) {
            Write-Error "Perplexity regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
            throw "Perplexity regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
          }
          if ([string]::IsNullOrWhiteSpace($result.response)) {
            Write-Error "Perplexity regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
            throw "Perplexity regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
          }
          if ($result.response.Trim() -ne $expected_answer) {
            Write-Error "Perplexity regression test failed: expected $expected_answer, got Perplexity output: '$($result.response)'"
            throw "Perplexity regression test failed: expected $expected_answer, got Perplexity output: '$($result.response)'"
          } else {
            Write-Output "Perplexity regression test passed: expected $expected_answer, Perplexity output: $($result.response)"
          }
        shell: pwsh

      - name: Upload Perplexity HTML artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: perplexity-artifacts
          path: artifacts/perplexity_*.html
          if-no-files-found: ignore

  grok-test:
    name: Grok Regression Test
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      - name: Verify Node
        run: |
          node -v
          npm -v
        shell: pwsh
  
      - name: Install Poetry
        run: python -m pip install --upgrade poetry==2.2.0

      - name: Install dependencies
        run: |
          poetry install
        shell: pwsh

      - name: Install Node.js dependencies
        run: |
          npm install
        shell: pwsh

      - name: Validate textgenhub installation
        run: |
          poetry run pip show textgenhub
        shell: pwsh
      
      - name: Create artifacts directory
        run: mkdir -p artifacts
        shell: pwsh
  
      - name: Run Grok regression test
        env:
          GROK_HEADLESS: false
        run: |
          $headless = if ([System.Environment]::GetEnvironmentVariable('GROK_HEADLESS') -eq 'false') { $false } else { $true }
          $jsonOutput = node ./src/textgenhub/grok/grok_cli.js --prompt "What is 2 + 2? Answer with only the number, no text, no explanation, just the single number." --headless $headless --debug | Select-String '^\{.*\}$' | ForEach-Object { $_.Line }
          if (-not $jsonOutput) {
            Write-Error "Grok regression test failed: No output from CLI script."
            throw "Grok regression test failed: No output from CLI script."
          }
          $result = $jsonOutput | ConvertFrom-Json
          $expected_answer = "4"
          
          # Check if error occurred and HTML artifact was saved
          if ($result.error) {
            Write-Error "Grok error occurred: $($result.error)"
            if ($result.artifactPath) {
              Write-Output "HTML artifact saved at: $($result.artifactPath)"
            }
            throw "Grok regression test failed: $($result.error)"
          }
          
          if (-not $result -or -not $result.response) {
            Write-Error "Grok regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
            throw "Grok regression test failed: Output JSON missing or null 'response' field. Raw output: $jsonOutput"
          }
          if ([string]::IsNullOrWhiteSpace($result.response)) {
            Write-Error "Grok regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
            throw "Grok regression test failed: Response is empty or whitespace. Raw response: '$($result.response)'"
          }
          if ($result.response.Trim() -ne $expected_answer) {
            Write-Error "Grok regression test failed: expected $expected_answer, got Grok output: '$($result.response)'"
            throw "Grok regression test failed: expected $expected_answer, got Grok output: '$($result.response)'"
          } else {
            Write-Output "Grok regression test passed: expected $expected_answer, Grok output: $($result.response)"
          }
        shell: pwsh

      - name: Upload Grok HTML artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: grok-artifacts
          path: artifacts/grok_*.html
          if-no-files-found: ignore

  notify:
      name: Send Failure Notification
      needs: [chatgpt-test, deepseek-test, perplexity-test, grok-test] 
      if: failure()
      runs-on: ubuntu-latest
      steps:
        - name: Send failure email
          uses: dawidd6/action-send-mail@v3
          with:
            server_address: smtp.gmail.com
            server_port: 587
            username: ${{ secrets.EMAIL_USERNAME }}
            password: ${{ secrets.EMAIL_PASSWORD }}
            subject: "ðŸš¨ [TextGen Github Project] LLM Regression Tests Failed"
            html_body: |
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:22px; font-weight:bold; color:red;">
                ðŸš¨ LLM Regression Tests Failed!
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
                One or more LLM providers (ChatGPT, DeepSeek, Perplexity, Grok) failed their regression tests.
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:16px;">
                <strong>ChatGPT Test:</strong> ${{ needs.chatgpt-test.result }}<br/>
                <strong>DeepSeek Test:</strong> ${{ needs.deepseek-test.result }}<br/>
                <strong>Perplexity Test:</strong> ${{ needs.perplexity-test.result }}<br/>
                <strong>Grok Test:</strong> ${{ needs.grok-test.result }}
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
                Check logs: <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Workflow Run</a>
              </p>
              <p style="font-family: 'Roboto', Helvetica, sans-serif; font-size:18px;">
                <strong>Debug Artifacts:</strong><br/>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">All Artifacts</a><br/>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">ChatGPT HTML</a><br/>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">DeepSeek HTML</a><br/>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">Perplexity HTML</a><br/>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts">Grok HTML</a>
              </p>
            to: ${{ secrets.EMAIL_USERNAME }}
            from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
